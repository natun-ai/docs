"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[5634],{4907:(e,t,n)=>{n.d(t,{Zo:()=>u,kt:()=>m});var r=n(9953);function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){a(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,r,a=function(e,t){if(null==e)return{};var n,r,a={},o=Object.keys(e);for(r=0;r<o.length;r++)n=o[r],t.indexOf(n)>=0||(a[n]=e[n]);return a}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(r=0;r<o.length;r++)n=o[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(a[n]=e[n])}return a}var c=r.createContext({}),s=function(e){var t=r.useContext(c),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},u=function(e){var t=s(e.components);return r.createElement(c.Provider,{value:t},e.children)},g="mdxType",p={inlineCode:"code",wrapper:function(e){var t=e.children;return r.createElement(r.Fragment,{},t)}},d=r.forwardRef((function(e,t){var n=e.components,a=e.mdxType,o=e.originalType,c=e.parentName,u=l(e,["components","mdxType","originalType","parentName"]),g=s(n),d=a,m=g["".concat(c,".").concat(d)]||g[d]||p[d]||o;return n?r.createElement(m,i(i({ref:t},u),{},{components:n})):r.createElement(m,i({ref:t},u))}));function m(e,t){var n=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var o=n.length,i=new Array(o);i[0]=d;var l={};for(var c in t)hasOwnProperty.call(t,c)&&(l[c]=t[c]);l.originalType=e,l[g]="string"==typeof e?e:a,i[1]=l;for(var s=2;s<o;s++)i[s]=n[s];return r.createElement.apply(null,i)}return r.createElement.apply(null,n)}d.displayName="MDXCreateElement"},1188:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>c,contentTitle:()=>i,default:()=>g,frontMatter:()=>o,metadata:()=>l,toc:()=>s});var r=n(1943),a=(n(9953),n(4907));const o={title:"Aggregations"},i=void 0,l={unversionedId:"docs/concepts/aggregations",id:"docs/concepts/aggregations",title:"Aggregations",description:"Aggregations are probably the most complex challenge while building a production-grade feature,",source:"@site/docs/docs/concepts/3-aggregations.md",sourceDirName:"docs/concepts",slug:"/docs/concepts/aggregations",permalink:"/docs/concepts/aggregations",draft:!1,editUrl:"https://github.com/raptor-ml/docs/tree/master/docs/docs/concepts/3-aggregations.md",tags:[],version:"current",sidebarPosition:3,frontMatter:{title:"Aggregations"},sidebar:"docs",previous:{title:"Data Sources",permalink:"/docs/concepts/datasources"},next:{title:"Derived feature (or How to do Joins?)",permalink:"/docs/concepts/derived"}},c={},s=[],u={toc:s};function g(e){let{components:t,...n}=e;return(0,a.kt)("wrapper",(0,r.Z)({},u,n,{components:t,mdxType:"MDXLayout"}),(0,a.kt)("p",null,"Aggregations are probably the most complex challenge while building a production-grade feature,\nthey require a ",(0,a.kt)("a",{parentName:"p",href:"/reference/how-does-raptor-work/features/aggregations"},"special mechanism")," to handle the data in\nproduction, but are relatively easy to implement in development."),(0,a.kt)("p",null,"Fortunately, it's relatively easy to build aggregations in Raptor."),(0,a.kt)("h1",{id:"rolling-window-aggregations"},"Rolling window aggregations"),(0,a.kt)("p",null,"Aggregations are usually being calculated on a rolling window, I.e. The amount of clicks over the last hour."),(0,a.kt)("p",null,"We can achieve that by using the ",(0,a.kt)("a",{parentName:"p",href:"/reference/labsdk/decorators#aggregation"},(0,a.kt)("inlineCode",{parentName:"a"},"@aggregation"))," decorator."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-python",metastring:"showLineNumbers",showLineNumbers:!0},"@feature(keys='user_id', data_source=Click)\n@aggregation(\n    function=AggregationFunction.Count,\n    over='10h',\n    granularity='1m'\n)\ndef clicks(this_row: Click, ctx: Context) -> int:\n    \"\"\"clicks over 10 hours\"\"\"\n    return 1\n")),(0,a.kt)("p",null,"Pretty simple right? let's go through what we did here line by line:"),(0,a.kt)("ol",null,(0,a.kt)("li",{parentName:"ol"},(0,a.kt)("p",{parentName:"li"},"We registered the feature with the ",(0,a.kt)("a",{parentName:"p",href:"/reference/labsdk/decorators#feature"},(0,a.kt)("inlineCode",{parentName:"a"},"@feature"))," decorator.")),(0,a.kt)("li",{parentName:"ol"},(0,a.kt)("p",{parentName:"li"},"We defined the aggregation function with the ",(0,a.kt)("a",{parentName:"p",href:"/reference/labsdk/decorators#aggregation"},(0,a.kt)("inlineCode",{parentName:"a"},"@aggregation"))," decorator."),(0,a.kt)("ol",{parentName:"li"},(0,a.kt)("li",{parentName:"ol"},"We set the aggregation function to be ",(0,a.kt)("inlineCode",{parentName:"li"},"count"),"."),(0,a.kt)("li",{parentName:"ol"},"We set the rolling window to be 10 hours."),(0,a.kt)("li",{parentName:"ol"},"We set the granularity to be 1 minute."))),(0,a.kt)("li",{parentName:"ol"},(0,a.kt)("p",{parentName:"li"},"We defined the feature function, which is a simple function that returns 1.\nThis is because we're counting the number of clicks, so we don't need to do any calculations."),(0,a.kt)("p",{parentName:"li"},"This will actually count the number of clicks over the last 10 hours, and will return the number of clicks."))),(0,a.kt)("h1",{id:"aggregation-functions"},"Aggregation functions"),(0,a.kt)("p",null,"Now that we know how to build aggregations, let's go ahead and build a feature that have multiple aggregation functions."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-python",metastring:"showLineNumbers",showLineNumbers:!0},"@feature(keys='account_id', data_source=Deal)\n@aggregation(\n    function=[AggregationFunction.Sum, AggregationFunction.Avg, AggregationFunction.Max, AggregationFunction.Min],\n    over='10h',\n    granularity='1m'\n)\ndef deals_10h(this_row: Deal, ctx: Context) -> float:\n    \"\"\"sum/avg/min/max of deal amount over 10 hours\"\"\"\n    return this_row['amount']\n")),(0,a.kt)("p",null,"In this example, we're building a feature that is calculating the sum, average, maximum and minimum of the deal amount."),(0,a.kt)("p",null,"This is actually generating for us multiple features, one for each aggregation function.\nWe can access them by specifying the aggregation function in the Feature Selector:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-python",metastring:"showLineNumbers",showLineNumbers:!0},'ctx.feature_get("default.deals_10h+sum")\n')))}g.isMDXComponent=!0}}]);